<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>MRT-Bot | Dashboard</title>
    <style>
        :root {
            --blurple: #5865F2;
            --success: #43b581;
            --danger: #f04747;
            --warning: #faa61a;
            --bg-main: #36393f;
            --bg-card: #2f3136;
            --bg-header: #202225;
            --text-primary: #ffffff;
            --text-muted: #b9bbbe;
            --border-color: #202225;
            --input-bg: #202225;
            --vscode-bg: #1e1e1e;
        }

        [data-theme="light"] {
            --bg-main: #ebedef;
            --bg-card: #ffffff;
            --bg-header: #f2f3f5;
            --text-primary: #060607;
            --text-muted: #4f5660;
            --border-color: #e3e5e8;
            --input-bg: #e3e5e8;
            --vscode-bg: #f3f3f3;
        }

        @keyframes blink-red {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .alert-blink {
            animation: blink-red 1.5s infinite;
        }

        body { font-family: sans-serif; background: var(--bg-main); color: var(--text-primary); padding: 40px; margin: 0; }
        .container { max-width: 1200px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--bg-header); padding: 20px; border-radius: 8px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: var(--bg-card); padding: 15px; border-radius: 8px; border-top: 3px solid var(--blurple); text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .stat-card span { display: block; color: var(--text-muted); font-size: 12px; text-transform: uppercase; margin-bottom: 5px; }
        .stat-card strong { font-size: 18px; color: var(--text-primary); }
        .stat-icon-img { width: 35px; height: 35px; border-radius: 50%; margin-bottom: 8px; background: #202225; object-fit: cover; }
        .btn-action { border: none; color: white; padding: 8px 14px; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 6px; font-size: 12px; }
        .system-bar { background: var(--bg-card); padding: 15px; border-radius: 8px; display: flex; gap: 15px; align-items: center; margin-bottom: 30px; border-left: 4px solid var(--warning); }
        .module-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .card { background: var(--bg-card); padding: 20px; border-radius: 8px; border-bottom: 3px solid var(--blurple); }
        .btn-toggle { border: none; padding: 10px; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; width: 100%; margin-top: 15px; }
        #searchInput { width: 100%; padding: 12px; margin: 20px 0; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); outline: none; box-sizing: border-box; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 5px; }
        tr { background: var(--bg-card); }
        td { padding: 12px 15px; vertical-align: middle; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); }
        .modal-content { background: var(--vscode-bg); margin: 2% auto; width: 90%; max-width: 1100px; border-radius: 8px; overflow: hidden; border: 1px solid #444; }
        .vscode-header { background: #323233; color: #ccc; padding: 10px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        .vscode-editor { width: 100%; height: 500px; background: #1e1e1e; color: #d4d4d4; border: none; padding: 20px; font-family: 'Consolas', monospace; font-size: 14px; outline: none; box-sizing: border-box; resize: none; }
        .console-box { background: #1a1a1a; color: #5865F2; font-family: 'Consolas', monospace; padding: 15px; border-radius: 8px; height: 180px; overflow-y: auto; font-size: 12px; margin-top: 30px; border: 1px solid #333; }
        .pma-table { width: 100%; border-collapse: collapse; background: #1a1a1a; }
        .pma-table th { background: #2d2d2d; color: #fff; text-align: left; padding: 10px; border: 1px solid #444; }
        .pma-table td { padding: 10px; border: 1px solid #444; color: #ccc; font-size: 13px; }
        .action-icon { cursor: pointer; font-size: 14px; background: none; border: none; padding: 4px; transition: 0.2s; }
        .action-icon:hover { transform: scale(1.2); }
        .edit-field { margin-bottom: 15px; }
        .edit-field label { display: block; color: #aaa; font-size: 12px; margin-bottom: 5px; }
        .edit-field input { width: 100%; padding: 8px; background: #1e1e1e; border: 1px solid #444; color: white; box-sizing: border-box; }
        .help-box { background: #2d2d2d; padding: 10px; border-radius: 4px; margin-top: 10px; border-left: 3px solid var(--blurple); font-size: 12px; color: #ccc; }
        
        .ai-sidebar { width: 320px; background: #252526; border-left: 1px solid #444; display: flex; flex-direction: column; overflow: hidden; }
        .ai-chat-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .ai-messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; background: #1e1e1e; }
        .msg { font-size: 12px; padding: 8px 12px; border-radius: 6px; max-width: 85%; line-height: 1.4; word-wrap: break-word; }
        .msg.user { align-self: flex-end; background: var(--blurple); color: white; }
        .msg.bot { align-self: flex-start; background: #333; color: #ddd; border: 1px solid #444; }
        .ai-footer { padding: 10px; background: #2d2d2d; border-top: 1px solid #444; }
        .ai-input { width: 100%; background: #3c3c3c; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; resize: none; font-size: 12px; box-sizing: border-box; outline: none; }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>MRT-Bot Dashboard</h1>
            <div style="display: flex; gap: 10px;">
                <button class="btn-action" style="background: var(--blurple)" onclick="toggleTheme()">üåì Th√®me</button>
                <a href="/login" class="btn-action" style="background: var(--danger); text-decoration: none;">D√©connexion</a>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><span>üì° Latence</span><strong id="stat-ping"><%= stats.ping %>ms</strong></div>
            <div class="stat-card"><img id="stat-icon" class="stat-icon-img" src="" style="display: none;"><span>üåê Serveur</span><strong id="stat-name"><%= stats.serverName %></strong></div>
            <div class="stat-card"><span>üë• Membres</span><strong id="stat-users"><%= stats.users %></strong></div>
            <div class="stat-card"><span>üíæ RAM</span><strong id="stat-ram"><%= stats.ram %> MB</strong></div>
        </div>

        <div class="system-bar">
            <strong>üì¶ Syst√®me :</strong>
            <button class="btn-action" style="background: var(--warning); color: #000;" onclick="openEditor('config.json', true)">üõ†Ô∏è Config</button>
            <button class="btn-action" style="background: var(--success);" onclick="openSqlBrowser()">üìÇ Explorer SQLite</button>
            <a href="/download-db" class="btn-action" style="background: #4e5058; text-decoration: none;">üíæ DB Backup</a>
        </div>

        <h2>‚öôÔ∏è Modules</h2>
        <div class="module-grid">
            <% let avMods=['Informations', 'Jeux' , 'Films' , 'Utilitaires' , 'Mod√©rations' , 'Gestions', 'Antiraid' , 'Contact' , 'Param√®tres' , 'FiveM' ]; %>
            <% avMods.forEach(name=> { %>
                <% const mod=modules.find(m=> m.moduleName === name); const isEnabled = mod ? mod.enabled : 1; %>
                <div class="card">
                    <div style="display: flex; justify-content: space-between;">
                        <strong><%= name %></strong>
                        <span style="color: <%= isEnabled ? '#43b581' : '#f04747' %>; font-size: 11px;">‚óè <%= isEnabled ? 'Allumer' : '√âteindre' %></span>
                    </div>
                    <form action="/toggle-module" method="POST">
                        <input type="hidden" name="moduleName" value="<%= name %>">
                        <input type="hidden" name="currentState" value="<%= isEnabled %>">
                        <button type="submit" class="btn-toggle" style="background: <%= isEnabled ? '#f04747' : '#43b581' %>"><%= isEnabled ? '√âteindre' : 'Allumer' %></button>
                    </form>
                </div>
            <% }); %>
        </div>

        <h2>üìö Commandes</h2>
        <input type="text" id="searchInput" onkeyup="searchCmd()" placeholder="Rechercher une commande...">
        <table id="cmdTable">
            <tbody>
                <% allCommands.forEach(cmd=> { %>
                    <% const status=cmdStatus.find(s=> s.commandName === cmd.name); const isEnabled = status ? status.enabled : 1; %>
                    <tr>
                        <td><strong style="color: var(--warning);">+<%= cmd.name %></strong></td>
                        <td><span style="background:rgba(88,101,242,0.1); color:var(--blurple); padding:4px 8px; border-radius:4px;"><%= cmd.category %></span></td>
                        <td align="right">
                            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                <button class="btn-action" style="background: #4e5058" onclick="openEditor('<%= cmd.name %>')">üìù Modifier</button>
                                <form action="/toggle-command" method="POST" style="margin:0;">
                                    <input type="hidden" name="commandName" value="<%= cmd.name %>">
                                    <input type="hidden" name="currentState" value="<%= isEnabled %>">
                                    <button type="submit" style="background: <%= isEnabled ? '#f04747' : '#43b581' %>; border:none; color:white; padding:5px 12px; border-radius:4px; cursor:pointer;"><%= isEnabled ? '√âteindre' : 'Allumer' %></button>
                                </form>
                            </div>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
        </table>

        <div id="panelLogsBox" class="console-box">En attente d'actions...</div>
    </div>

    <div id="editorModal" class="modal">
        <div class="modal-content" style="max-width: 1300px;">
            <div class="vscode-header">
                <span id="fileNameDisplay">script.js</span>
                <span id="aiStatus" style="font-size: 10px; color: var(--text-muted);"></span>
                <span onclick="closeEditor()" style="cursor:pointer; padding: 0 10px;">‚úñ</span>
            </div>
            <div style="display: flex; height: 600px;">
                <textarea id="codeEditor" class="vscode-editor" spellcheck="false" style="flex: 1;"></textarea>
                <div class="ai-sidebar">
                    <div id="aiContent" class="ai-chat-container">
                        <div id="aiMessages" class="ai-messages"></div>
                        <div class="ai-footer">
                            <textarea id="aiPrompt" class="ai-input" placeholder="Poser une question ou demander une modif..." rows="3"></textarea>
                            <button id="btnSendAI" class="btn-action" style="background: var(--blurple); width: 100%; justify-content: center; margin-top: 8px;" onclick="askAI()">Envoyer</button>
                        </div>
                    </div>
                </div>
            </div>
            <div style="padding: 10px; background: #252526; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn-action" style="background:#444" onclick="closeEditor()">Annuler</button>
                <button class="btn-action" style="background:#007acc" onclick="saveCode()">Enregistrer</button>
            </div>
        </div>
    </div>

    <div id="sqlModal" class="modal">
        <div class="modal-content" style="height: 85vh; display: flex; flex-direction: column;">
            <div class="vscode-header"><span>SQL Browser (database.sqlite3)</span><span onclick="closeSqlBrowser()" style="cursor:pointer">‚úñ</span></div>
            <div style="display: flex; flex: 1; overflow: hidden;">
                <div id="tableList" style="width: 220px; background: #252526; border-right: 1px solid #444; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;"></div>
                <div style="flex: 1; display: flex; flex-direction: column; background: #1e1e1e; padding: 15px; overflow: hidden;">
                    <div style="background: #252526; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #444;">
                        <div style="display: flex; gap: 10px; align-items: flex-end;">
                            <div style="flex: 1;">
                                <label style="display: block; font-size: 10px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase;">‚ö° Ex√©cuter une ligne SQL</label>
                                <input type="text" id="quickSqlQuery" placeholder="Ex: UPDATE users SET money = 1000 WHERE userId = '123'" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #333; color: #4ec9b0; border-radius: 4px; outline: none;">
                            </div>
                            <button class="btn-action" style="background: var(--blurple); height: 34px;" onclick="executeQuickQuery()">‚ñ∂Ô∏è</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button class="btn-action" style="background: var(--blurple);" onclick="promptCreateTable()">‚ûï Cr√©er une table</button>
                        <button class="btn-action" style="background: var(--warning); color:#000; display:none;" id="emptyTableBtn" onclick="openEmptyModal()">üóëÔ∏è Vider la table</button>
                    </div>
                    <div id="sqlResult" style="flex: 1; overflow: auto; background: #1a1a1a; border: 1px solid #333;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="editRowModal" class="modal">
        <div class="modal-content" style="max-width: 500px; margin-top: 10%;">
            <div class="vscode-header"><span>‚úèÔ∏è √âditer la ligne</span><span onclick="closeEditModal()" style="cursor:pointer">‚úñ</span></div>
            <div id="editFieldsContainer" style="padding: 20px;"></div>
            <div style="padding: 15px; background: #252526; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn-action" style="background:#444" onclick="closeEditModal()">Annuler</button>
                <button class="btn-action" style="background:var(--success)" onclick="submitEdit()">Sauvegarder</button>
            </div>
        </div>
    </div>

    <div id="createTableModal" class="modal">
        <div class="modal-content" style="max-width: 550px; margin-top: 8%;">
            <div class="vscode-header"><span>‚ûï Cr√©er une nouvelle table</span><span onclick="closeCreateModal()" style="cursor:pointer">‚úñ</span></div>
            <div style="padding: 20px;">
                <div class="edit-field"><label>Nom de la table</label><input type="text" id="newTableName" placeholder="ex: economy"></div>
                <div class="edit-field"><label>Colonnes (Format SQL)</label><input type="text" id="newTableCols" placeholder="id INTEGER PRIMARY KEY, userId TEXT, balance INT"></div>
                <div class="help-box" style="line-height: 1.6;">
                    <strong style="color:var(--blurple); display: block; margin-bottom: 5px;">üå± Guide pour d√©butants :</strong>
                    ‚Ä¢ <code style="color:#ce9178">TEXT</code> : Pour du texte.<br>
                    ‚Ä¢ <code style="color:#b5cea8">INTEGER</code> : Pour des nombres.<br>
                    ‚Ä¢ <code style="color:#569cd6">PRIMARY KEY</code> : La cl√© unique.
                </div>
            </div>
            <div style="padding: 15px; background: #252526; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn-action" style="background:#444" onclick="closeCreateModal()">Annuler</button>
                <button class="btn-action" style="background:var(--blurple)" onclick="submitCreateTable()">Cr√©er la table</button>
            </div>
        </div>
    </div>

    <div id="actionConfirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px; margin-top: 15%;">
            <div class="vscode-header"><span>Confirmation</span><span onclick="closeConfirmModal()" style="cursor:pointer">‚úñ</span></div>
            <div style="padding: 20px; text-align: center;">
                <p id="confirmMessage"></p>
                <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
                    <button class="btn-action" style="background:#444" onclick="closeConfirmModal()">Annuler</button>
                    <button class="btn-action" style="background:var(--danger)" id="confirmBtn">Confirmer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentEditingFile = "";
        let currentOpenedTable = "";
        let hasGeminiKey = false;
        let aiHistory = [];
        let editRowData = { table: "", idKey: "", idVal: "", columns: [] };

        async function openEditor(name, isRaw = false) {
            currentEditingFile = name;
            aiHistory = [];
            document.getElementById('aiMessages').innerHTML = `<div class="msg bot">Fichier <b>${name}</b> charg√©. Comment puis-je vous aider ?</div>`;
            document.getElementById('fileNameDisplay').innerText = name + (isRaw ? "" : ".js");
            document.getElementById('editorModal').style.display = 'block';
            const res = await fetch('/get-script/' + name);
            const data = await res.json();
            document.getElementById('codeEditor').value = data.content || data.error;
        }

        async function askAI() {
            const promptInput = document.getElementById('aiPrompt');
            const message = promptInput.value.trim();
            const currentCode = document.getElementById('codeEditor').value;
            const msgContainer = document.getElementById('aiMessages');
            const btn = document.getElementById('btnSendAI');
            if (!message || !hasGeminiKey) return;
            msgContainer.innerHTML += `<div class="msg user">${message}</div>`;
            promptInput.value = "";
            msgContainer.scrollTop = msgContainer.scrollHeight;
            btn.disabled = true;
            try {
                const res = await fetch('/api/ai-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, code: currentCode, fileName: currentEditingFile, history: aiHistory })
                });
                const data = await res.json();
                aiHistory.push({ user: message, bot: data.reply });
                if (aiHistory.length > 10) aiHistory.shift();
                msgContainer.innerHTML += `<div class="msg bot">${data.reply}</div>`;
                if (data.newCode) {
                    document.getElementById('codeEditor').value = data.newCode;
                    msgContainer.innerHTML += `<div class="msg bot" style="font-style:italic; font-size:10px;">‚ú® Code mis √† jour.</div>`;
                }
            } catch (e) { msgContainer.innerHTML += `<div class="msg bot" style="color:var(--danger)">Erreur IA.</div>`; }
            btn.disabled = false;
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }

        async function saveCode() {
            const content = document.getElementById('codeEditor').value;
            const res = await fetch('/save-script', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fileName: currentEditingFile, content })
            });
            if ((await res.json()).success) closeEditor();
        }

        async function openSqlBrowser() {
            document.getElementById('sqlModal').style.display = 'block';
            const res = await fetch('/sql-tables');
            const tables = await res.json();
            const list = document.getElementById('tableList');
            list.innerHTML = '';
            tables.forEach(t => {
                const container = document.createElement('div');
                container.style = "display:flex; justify-content:space-between; align-items:center; background:#2d2d2d; border-radius:4px; padding-right:5px; margin-bottom:5px;";
                const b = document.createElement('button');
                b.innerText = t; b.style = "background:none; border:none; color:#ddd; text-align:left; cursor:pointer; padding:8px; font-size:13px; flex:1;";
                b.onclick = () => loadTableData(t);
                const del = document.createElement('button');
                del.innerHTML = "üóëÔ∏è"; del.style = "background:none; border:none; color:var(--danger); cursor:pointer;";
                del.onclick = (e) => {
                    e.stopPropagation(); openConfirmModal(`Supprimer la table ${t} ?`, async () => {
                        await fetch('/sql-query', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query: `DROP TABLE ${t}` }) });
                        openSqlBrowser();
                    });
                };
                container.appendChild(b); container.appendChild(del);
                list.appendChild(container);
            });
        }

        async function loadTableData(tableName) {
            currentOpenedTable = tableName;
            document.getElementById('emptyTableBtn').style.display = 'flex';
            const res = await fetch('/sql-query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: `SELECT * FROM ${tableName} LIMIT 100` })
            });
            const data = await res.json();
            const resultDiv = document.getElementById('sqlResult');
            if (data.rows && data.rows.length > 0) {
                const columns = Object.keys(data.rows[0]);
                let h = `<table class="pma-table"><thead><tr><th style="width:70px;">Actions</th>`;
                columns.forEach(k => h += `<th>${k}</th>`);
                h += `</tr></thead><tbody>`;
                data.rows.forEach(r => {
                    const rowJson = JSON.stringify(r).replace(/"/g, '&quot;');
                    h += `<tr><td><button class="action-icon" onclick="openEditModal('${tableName}', ${rowJson})">‚úèÔ∏è</button><button class="action-icon" style="color:var(--danger)" onclick="openConfirmModal('Supprimer ?', async () => { await fetch('/sql-query', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query: 'DELETE FROM ${tableName} WHERE ${columns[0]} = \\'${r[columns[0]]}\\' ' }) }); loadTableData('${tableName}'); })">üóëÔ∏è</button></td>`;
                    Object.values(r).forEach(v => h += `<td>${v}</td>`);
                    h += `</tr>`;
                });
                resultDiv.innerHTML = h + `</tbody></table>`;
            } else resultDiv.innerHTML = `<p style="padding:20px; color:#888;">Table vide.</p>`;
        }

        async function executeQuickQuery() {
            const query = document.getElementById('quickSqlQuery').value.trim();
            if (!query) return;
            openConfirmModal("Ex√©cuter SQL ?", async () => {
                const res = await fetch('/sql-query', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
                const data = await res.json();
                if (data.error) alert(data.error);
                else { document.getElementById('quickSqlQuery').value = ""; if (currentOpenedTable) loadTableData(currentOpenedTable); }
            });
        }

        function openEditModal(tableName, rowData) {
            editRowData.table = tableName; editRowData.columns = Object.keys(rowData);
            editRowData.idKey = editRowData.columns[0]; editRowData.idVal = rowData[editRowData.idKey];
            const container = document.getElementById('editFieldsContainer');
            container.innerHTML = "";
            editRowData.columns.forEach(col => { container.innerHTML += `<div class="edit-field"><label>${col}</label><input type="text" id="edit_col_${col}" value="${rowData[col]}"></div>`; });
            document.getElementById('editRowModal').style.display = 'block';
        }

        async function submitEdit() {
            const updates = editRowData.columns.map(col => `${col} = '${document.getElementById(`edit_col_${col}`).value}'`);
            const query = `UPDATE ${editRowData.table} SET ${updates.join(', ')} WHERE ${editRowData.idKey} = '${editRowData.idVal}'`;
            await fetch('/sql-query', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
            closeEditModal(); loadTableData(editRowData.table);
        }

        function promptCreateTable() { document.getElementById('createTableModal').style.display = 'block'; }
        async function submitCreateTable() {
            const n = document.getElementById('newTableName').value; const c = document.getElementById('newTableCols').value;
            await fetch('/sql-query', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query: `CREATE TABLE IF NOT EXISTS ${n} (${c})` }) });
            closeCreateModal(); openSqlBrowser();
        }

        function openConfirmModal(msg, action) {
            document.getElementById('confirmMessage').innerText = msg;
            document.getElementById('actionConfirmModal').style.display = 'block';
            document.getElementById('confirmBtn').onclick = () => { action(); closeConfirmModal(); };
        }

        function openEmptyModal() { openConfirmModal(`Vider ${currentOpenedTable} ?`, async () => { await fetch('/sql-query', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query: `DELETE FROM ${currentOpenedTable}` }) }); loadTableData(currentOpenedTable); }); }
        function searchCmd() { let v = document.getElementById('searchInput').value.toLowerCase(); document.querySelectorAll('#cmdTable tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(v) ? "" : "none"); }
        function closeEditor() { document.getElementById('editorModal').style.display = 'none'; }
        function closeSqlBrowser() { document.getElementById('sqlModal').style.display = 'none'; }
        function closeEditModal() { document.getElementById('editRowModal').style.display = 'none'; }
        function closeConfirmModal() { document.getElementById('actionConfirmModal').style.display = 'none'; }
        function closeCreateModal() { document.getElementById('createTableModal').style.display = 'none'; }

        setInterval(async () => {
    try {
        const res = await fetch('/api/stats');
        const data = await res.json();
        
        document.getElementById('stat-ping').innerText = data.ping + "ms";
        document.getElementById('stat-name').innerText = data.serverName;
        document.getElementById('stat-users').innerText = data.users;
        document.getElementById('stat-ram').innerText = data.ram + " MB";
        
        const icon = document.getElementById('stat-icon');
        if (data.icon) {
            icon.src = data.icon;
            icon.style.display = 'block';
        }

        hasGeminiKey = data.geminiKey;
        const aiStatusEl = document.getElementById('aiStatus');

        if (!data.geminiKey) {
            aiStatusEl.innerHTML = "<b class='alert-blink' style='color:var(--danger)'>‚ö†Ô∏è IA OFF (Manquante)</b>";
        } else if (data.geminiValid === false) {
            aiStatusEl.innerHTML = "<b class='alert-blink' style='color:var(--warning)'>‚ùå CL√â INVALIDE</b>";
            hasGeminiKey = false;
        } else {
            aiStatusEl.innerHTML = "<span style='color:var(--success)'>üü¢ IA ACTIVE</span>";
        }

        const lr = await fetch('/get-panel-logs');
        const ld = await lr.json();
        document.getElementById('panelLogsBox').innerHTML = ld.logs.join('<br>');
    } catch (e) {}
}, 3000);

        function toggleTheme() {
            let t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', t); localStorage.setItem('theme', t);
        }
        document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'dark');
    </script>
</body>
</html>